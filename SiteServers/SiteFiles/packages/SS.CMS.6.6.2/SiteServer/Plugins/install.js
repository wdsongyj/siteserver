var $ssApi=new apiUtils.Api,$apiUrl=$apiConfig.innerApiUrl,$api=new apiUtils.Api($apiUrl+"/pages/plugins/install"),$packageIds=pageUtils.getQueryStringByName("packageIds").split(","),$pageType="true"===pageUtils.getQueryStringByName("isUpdate")?"升级":"安装",data={packageIds:$packageIds,pageLoad:!1,pageAlert:null,pageType:$pageType,pageStep:1,isNightly:!1,version:null,downloadPlugins:null,downloadApi:null,updateApi:null,clearCacheApi:null,listPackages:[],listIndex:0,currentPackage:{},currentPackages:[],currentDownloadingId:0,currentDownloadIds:[],currentUpdatingId:0,currentUpdatedIds:[]},methods={getConfig:function(){var e=this;$api.get(null,function(a,n){!a&&n&&(e.isNightly=n.isNightly,e.version=n.version,e.downloadPlugins=n.downloadPlugins,e.downloadApi=new apiUtils.Api(n.downloadApiUrl),e.updateApi=new apiUtils.Api(n.updateApiUrl),e.clearCacheApi=new apiUtils.Api(n.clearCacheApiUrl),e.getListPackages())},"config")},getListPackages:function(){var e=this;$ssApi.get({isNightly:e.isNightly,version:e.version,$filter:"id in '"+e.packageIds.join(",")+"'"},function(a,n){if(!a&&n&&n.value){for(var i=0;i<n.value.length;i++){var t=n.value[i];e.listPackages.push(t)}e.pageLoad=!0,e.installListPackage()}},"packages")},installListPackage:function(){var e=this;if(e.listIndex===e.listPackages.length)return void e.clearCache();e.package=e.listPackages[e.listIndex],e.currentPackages.push(e.package);for(var a=[],n=0;n<e.package.pluginReferences.length;n++){var i=e.package.pluginReferences[n];0===$.grep(e.currentPackages,function(e){return e.id==i.id}).length&&a.push(i.id)}for(var t=0;t<e.package.packageReferences.length;t++){var r=e.package.packageReferences[t];0===$.grep(e.currentPackages,function(e){return e.id==r.id}).length&&a.push(r.id)}if(0===a.length)return void e.download();$ssApi.get({isNightly:e.isNightly,version:e.version,$filter:"id in '"+a.join(",")+"'"},function(a,n){if(!a&&n&&n.value){for(var i=0;i<n.value.length;i++){for(var t=n.value[i],r=0;r<e.downloadPlugins.length;r++){if(e.downloadPlugins[r]===t.id+"."+t.version){e.currentDownloadIds.push(t.id);break}}e.currentPackages.push(t)}e.download()}},"packages")},download:function(){for(var e=this,a=0;a<e.currentPackages.length;a++){var n=e.currentPackages[a];if(-1==e.currentDownloadIds.indexOf(n.id))return e.currentDownloadingId=n.id,void e.downloadPackage(n.id,n.version)}e.update()},downloadPackage:function(e,a){var n=this;n.downloadApi.post({packageId:e,version:a},function(a,i){a?n.pageAlert={type:"error",html:a.message}:i&&(n.currentDownloadingId=0,n.currentDownloadIds.push(e),n.download())})},update:function(){var e=this;e.pageStep=2;for(var a=0;a<e.currentPackages.length;a++){var n=e.currentPackages[a];if(-1==e.currentUpdatedIds.indexOf(n.id))return e.currentUpdatingId=n.id,void e.updatePackage(n.id,n.version,n.packageType)}e.updateSuccess()},updatePackage:function(e,a,n){var i=this;i.updateApi.post({packageId:e,version:a,packageType:n},function(a,n){a?i.pageAlert={type:"error",html:a.message}:n&&(i.currentUpdatingId=0,i.currentUpdatedIds.push(e),i.update())})},updateSuccess:function(){var e=this;e.listIndex++,e.pageStep=1,e.currentPackage={},e.currentPackages=[],e.currentDownloadingId=0,e.currentDownloadIds=[],e.currentUpdatingId=0,e.currentUpdatedIds=[],e.installListPackage()},clearCache:function(){var e=this;e.pageStep=0,e.clearCacheApi.post(null,function(a,n){a?e.pageAlert={type:"error",html:a.message}:setTimeout(function(){window.top.location.reload(!0)},3e3)})}},$vue=new Vue({el:"#main",data:data,methods:methods});$vue.getConfig();