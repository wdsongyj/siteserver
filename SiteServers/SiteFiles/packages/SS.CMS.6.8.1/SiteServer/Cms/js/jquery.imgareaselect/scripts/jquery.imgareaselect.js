!function(e){var t=Math.abs,o=Math.max,i=Math.min,n=Math.round;function s(){return e("<div/>")}e.imgAreaSelect=function(d,r){var a,c,l,u,h,f,m,p,y,b,g,x,v,w,S,z,k,C,A,W,I,K,P,N,H,M,O,E,T,L=e(d),j=s(),D=s(),R=s().add(s()).add(s()).add(s()),$=s().add(s()).add(s()).add(s()),q=e([]),B={left:0,top:0},Q={left:0,top:0},X=0,Y="absolute",F={x1:0,y1:0,x2:0,y2:0,width:0,height:0},G=document.documentElement,J=navigator.userAgent;function U(e){return e+B.left-Q.left}function V(e){return e+B.top-Q.top}function Z(e){return e-B.left+Q.left}function _(e){return e-B.top+Q.top}function ee(e){return e.pageX-Q.left}function te(e){return e.pageY-Q.top}function oe(e){var t=e||b,o=e||g;return{x1:n(F.x1*t),y1:n(F.y1*o),x2:n(F.x2*t),y2:n(F.y2*o),width:n(F.x2*t)-n(F.x1*t),height:n(F.y2*o)-n(F.y1*o)}}function ie(e,t,o,i,s){var d=s||b,r=s||g;(F={x1:n(e/d||0),y1:n(t/r||0),x2:n(o/d||0),y2:n(i/r||0)}).width=F.x2-F.x1,F.height=F.y2-F.y1}function ne(){a&&L.width()&&(B={left:n(L.offset().left),top:n(L.offset().top)},h=L.innerWidth(),f=L.innerHeight(),B.top+=L.outerHeight()-f>>1,B.left+=L.outerWidth()-h>>1,v=n(r.minWidth/b)||0,w=n(r.minHeight/g)||0,S=n(i(r.maxWidth/b||1<<24,h)),z=n(i(r.maxHeight/g||1<<24,f)),"1.3.2"!=e().jquery||"fixed"!=Y||G.getBoundingClientRect||(B.top+=o(document.body.scrollTop,G.scrollTop),B.left+=o(document.body.scrollLeft,G.scrollLeft)),Q=/absolute|relative/.test(m.css("position"))?{left:n(m.offset().left)-m.scrollLeft(),top:n(m.offset().top)-m.scrollTop()}:"fixed"==Y?{left:e(document).scrollLeft(),top:e(document).scrollTop()}:{left:0,top:0},l=U(0),u=V(0),(F.x2>h||F.y2>f)&&he())}function se(t){if(C){switch(j.css({left:U(F.x1),top:V(F.y1)}).add(D).width(O=F.width).height(E=F.height),D.add(R).add(q).css({left:0,top:0}),R.width(o(O-R.outerWidth()+R.innerWidth(),0)).height(o(E-R.outerHeight()+R.innerHeight(),0)),e($[0]).css({left:l,top:u,width:F.x1,height:f}),e($[1]).css({left:l+F.x1,top:u,width:O,height:F.y1}),e($[2]).css({left:l+F.x2,top:u,width:h-F.x2,height:f}),e($[3]).css({left:l+F.x1,top:u+F.y2,width:O,height:f-F.y2}),O-=q.outerWidth(),E-=q.outerHeight(),q.length){case 8:e(q[4]).css({left:O>>1}),e(q[5]).css({left:O,top:E>>1}),e(q[6]).css({left:O>>1,top:E}),e(q[7]).css({top:E>>1});case 4:q.slice(1,3).css({left:O}),q.slice(2,4).css({top:E})}!1!==t&&(e.imgAreaSelect.onKeyPress!=we&&e(document).unbind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress),r.keys&&e(document)[e.imgAreaSelect.keyPress](e.imgAreaSelect.onKeyPress=we)),ke&&R.outerWidth()-R.innerWidth()==2&&(R.css("margin",0),setTimeout(function(){R.css("margin","auto")},0))}}function de(e){ne(),se(e),A=U(F.x1),W=V(F.y1),I=U(F.x2),K=V(F.y2)}function re(e,t){r.fadeSpeed?e.fadeOut(r.fadeSpeed,t):e.hide()}function ae(e){var t=Z(ee(e))-F.x1,o=_(te(e))-F.y1;T||(ne(),T=!0,j.one("mouseout",function(){T=!1})),x="",r.resizable&&(o<=r.resizeMargin?x="n":o>=F.height-r.resizeMargin&&(x="s"),t<=r.resizeMargin?x+="w":t>=F.width-r.resizeMargin&&(x+="e")),j.css("cursor",x?x+"-resize":r.movable?"move":""),c&&c.toggle()}function ce(t){e("body").css("cursor",""),(r.autoHide||F.width*F.height==0)&&re(j.add($),function(){e(this).hide()}),e(document).unbind("mousemove",fe),j.mousemove(ae),r.onSelectEnd(d,oe())}function le(t){return 1==t.which&&(ne(),x?(e("body").css("cursor",x+"-resize"),A=U(F[/w/.test(x)?"x2":"x1"]),W=V(F[/n/.test(x)?"y2":"y1"]),e(document).mousemove(fe).one("mouseup",ce),j.unbind("mousemove",ae)):r.movable?(p=l+F.x1-ee(t),y=u+F.y1-te(t),j.unbind("mousemove",ae),e(document).mousemove(pe).one("mouseup",function(){r.onSelectEnd(d,oe()),e(document).unbind("mousemove",pe),j.mousemove(ae)})):L.mousedown(t),!1)}function ue(e){k&&(e?(I=o(l,i(l+h,A+t(K-W)*k*(I>A||-1))),K=n(o(u,i(u+f,W+t(I-A)/k*(K>W||-1)))),I=n(I)):(K=o(u,i(u+f,W+t(I-A)/k*(K>W||-1))),I=n(o(l,i(l+h,A+t(K-W)*k*(I>A||-1)))),K=n(K)))}function he(){A=i(A,l+h),W=i(W,u+f),t(I-A)<v&&((I=A-v*(I<A||-1))<l?A=l+v:I>l+h&&(A=l+h-v)),t(K-W)<w&&((K=W-w*(K<W||-1))<u?W=u+w:K>u+f&&(W=u+f-w)),I=o(l,i(I,l+h)),K=o(u,i(K,u+f)),ue(t(I-A)<t(K-W)*k),t(I-A)>S&&(I=A-S*(I<A||-1),ue()),t(K-W)>z&&(K=W-z*(K<W||-1),ue(!0)),F={x1:Z(i(A,I)),x2:Z(o(A,I)),y1:_(i(W,K)),y2:_(o(W,K)),width:t(I-A),height:t(K-W)},se(),r.onSelectChange(d,oe())}function fe(e){return I=/w|e|^$/.test(x)||k?ee(e):U(F.x2),K=/n|s|^$/.test(x)||k?te(e):V(F.y2),he(),!1}function me(t,o){I=(A=t)+F.width,K=(W=o)+F.height,e.extend(F,{x1:Z(A),y1:_(W),x2:Z(I),y2:_(K)}),se(),r.onSelectChange(d,oe())}function pe(e){return A=o(l,i(p+ee(e),l+h-F.width)),W=o(u,i(y+te(e),u+f-F.height)),me(A,W),e.preventDefault(),!1}function ye(){e(document).unbind("mousemove",ye),ne(),I=A,K=W,he(),x="",$.is(":visible")||j.add($).hide().fadeIn(r.fadeSpeed||0),C=!0,e(document).unbind("mouseup",be).mousemove(fe).one("mouseup",ce),j.unbind("mousemove",ae),r.onSelectStart(d,oe())}function be(){e(document).unbind("mousemove",ye).unbind("mouseup",be),re(j.add($)),ie(Z(A),_(W),Z(A),_(W)),this instanceof e.imgAreaSelect||(r.onSelectChange(d,oe()),r.onSelectEnd(d,oe()))}function ge(t){return 1==t.which&&!$.is(":animated")&&(ne(),p=A=ee(t),y=W=te(t),e(document).mousemove(ye).mouseup(be),!1)}function xe(){de(!1)}function ve(){a=!0,ze(r=e.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},r)),j.add($).css({visibility:""}),r.show&&(C=!0,ne(),se(),j.add($).hide().fadeIn(r.fadeSpeed||0)),setTimeout(function(){r.onInit(d,oe())},0)}var we=function(e){var t,n,s=r.keys,d=e.keyCode;if(t=isNaN(s.alt)||!e.altKey&&!e.originalEvent.altKey?!isNaN(s.ctrl)&&e.ctrlKey?s.ctrl:!isNaN(s.shift)&&e.shiftKey?s.shift:isNaN(s.arrows)?10:s.arrows:s.alt,"resize"==s.arrows||"resize"==s.shift&&e.shiftKey||"resize"==s.ctrl&&e.ctrlKey||"resize"==s.alt&&(e.altKey||e.originalEvent.altKey)){switch(d){case 37:t=-t;case 39:n=o(A,I),A=i(A,I),I=o(n+t,A),ue();break;case 38:t=-t;case 40:n=o(W,K),W=i(W,K),K=o(n+t,W),ue(!0);break;default:return}he()}else switch(A=i(A,I),W=i(W,K),d){case 37:me(o(A-t,l),W);break;case 38:me(A,o(W-t,u));break;case 39:me(A+i(t,h-Z(I)),W);break;case 40:me(A,W+i(t,f-_(K)));break;default:return}return!1};function Se(e,t){for(var o in t)void 0!==r[o]&&e.css(t[o],r[o])}function ze(t){if(t.parent&&(m=e(t.parent)).append(j.add($)),e.extend(r,t),ne(),null!=t.handles){for(q.remove(),q=e([]),H=t.handles?"corners"==t.handles?4:8:0;H--;)q=q.add(s());q.addClass(r.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:X+1||1}),!parseInt(q.css("width"))>=0&&q.width(5).height(5),(M=r.borderWidth)&&q.css({borderWidth:M,borderStyle:"solid"}),Se(q,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}for(b=r.imageWidth/h||1,g=r.imageHeight/f||1,null!=t.x1&&(ie(t.x1,t.y1,t.x2,t.y2),t.show=!t.hide),t.keys&&(r.keys=e.extend({shift:1,ctrl:"resize"},t.keys)),$.addClass(r.classPrefix+"-outer"),D.addClass(r.classPrefix+"-selection"),H=0;H++<4;)e(R[H-1]).addClass(r.classPrefix+"-border"+H);Se(D,{selectionColor:"background-color",selectionOpacity:"opacity"}),Se(R,{borderOpacity:"opacity",borderWidth:"border-width"}),Se($,{outerColor:"background-color",outerOpacity:"opacity"}),(M=r.borderColor1)&&e(R[0]).css({borderStyle:"solid",borderColor:M}),(M=r.borderColor2)&&e(R[1]).css({borderStyle:"dashed",borderColor:M}),j.append(D.add(R).add(c)).append(q),ke&&((M=($.css("filter")||"").match(/opacity=(\d+)/))&&$.css("opacity",M[1]/100),(M=(R.css("filter")||"").match(/opacity=(\d+)/))&&R.css("opacity",M[1]/100)),t.hide?re(j.add($)):t.show&&a&&(C=!0,j.add($).fadeIn(r.fadeSpeed||0),de()),k=(N=(r.aspectRatio||"").split(/:/))[0]/N[1],L.add($).unbind("mousedown",ge),r.disable||!1===r.enable?(j.unbind("mousemove",ae).unbind("mousedown",le),e(window).unbind("resize",xe)):((r.enable||!1===r.disable)&&((r.resizable||r.movable)&&j.mousemove(ae).mousedown(le),e(window).resize(xe)),r.persistent||L.add($).mousedown(ge)),r.enable=r.disable=void 0}this.remove=function(){ze({disable:!0}),j.add($).remove()},this.getOptions=function(){return r},this.setOptions=ze,this.getSelection=oe,this.setSelection=ie,this.cancelSelection=be,this.update=de;var ke=(/msie ([\w.]+)/i.exec(J)||[])[1],Ce=/opera/i.test(J),Ae=/webkit/i.test(J)&&!/chrome/i.test(J);for(P=L;P.length;)X=o(X,isNaN(P.css("z-index"))?X:P.css("z-index")),"fixed"==P.css("position")&&(Y="fixed"),P=P.parent(":not(body)");X=r.zIndex||X,ke&&L.attr("unselectable","on"),e.imgAreaSelect.keyPress=ke||Ae?"keydown":"keypress",Ce&&(c=s().css({width:"100%",height:"100%",position:"absolute",zIndex:X+2||2})),j.add($).css({visibility:"hidden",position:Y,overflow:"hidden",zIndex:X||"0"}),j.css({zIndex:X+2||2}),D.add(R).css({position:"absolute",fontSize:0}),d.complete||"complete"==d.readyState||!L.is("img")?ve():L.one("load",ve),!a&&ke&&ke>=7&&(d.src=d.src)},e.fn.imgAreaSelect=function(t){return t=t||{},this.each(function(){e(this).data("imgAreaSelect")?t.remove?(e(this).data("imgAreaSelect").remove(),e(this).removeData("imgAreaSelect")):e(this).data("imgAreaSelect").setOptions(t):t.remove||(void 0===t.enable&&void 0===t.disable&&(t.enable=!0),e(this).data("imgAreaSelect",new e.imgAreaSelect(this,t)))}),t.instance?e(this).data("imgAreaSelect"):this}}(jQuery);