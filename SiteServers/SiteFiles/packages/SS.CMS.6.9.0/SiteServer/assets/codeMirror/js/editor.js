function makeWhiteSpace(e){for(var t=[],n=!0;e>0;e--)t.push(n||1==e?nbsp:" "),n=!n;return t.join("")}function fixSpaces(e){return" "==e.charAt(0)&&(e=nbsp+e.slice(1)),e.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(e){return makeWhiteSpace(e.length)})}function cleanText(e){return e.replace(/\u00a0/g," ").replace(/\u200b/g,"")}function makePartSpan(e,t){var n=e;3==e.nodeType?n=e.nodeValue:e=t.createTextNode(n);var i=t.createElement("SPAN");return i.isPart=!0,i.appendChild(e),i.currentText=n,i}var webkitLastLineHack=webkit?function(e){var t=e.lastChild;t&&t.isPart&&"​"==t.textContent||e.appendChild(makePartSpan("​",e.ownerDocument))}:function(){},Editor=function(){var e={P:!0,DIV:!0,LI:!0};function t(e){var t=makeWhiteSpace(indentUnit);return map(e.replace(/\t/g,t).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function n(t){function n(e,t){return r=t,e}function i(e,t,n){return function(){return e(t,n)}}var r=i(function t(r,c){r.nextSibling&&(c=i(t,r.nextSibling,c));return function(e){if(e.isPart&&1==e.childNodes.length&&3==e.firstChild.nodeType)return e.currentText=e.firstChild.nodeValue,!/[\n\t\r]/.test(e.currentText);return!1}(r)?(s.push(r),n(r.currentText,c)):"BR"==r.nodeName?(s.push(r),n("\n",c)):(a=function(e){var t=e.parentNode,n=e.nextSibling;return function(e){t.insertBefore(e,n)}}(r),removeElement(r),function(t,i){var r=[];return forEach((c=t,h=c.ownerDocument,l=[],d=!0,function t(n){3==n.nodeType?((n.nodeValue=fixSpaces(n.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "))).length&&(d=!1),l.push(n)):"BR"==n.nodeName&&0==n.childNodes.length?(d=!0,l.push(n)):(forEach(n.childNodes,t),!d&&e.hasOwnProperty(n.nodeName)&&(d=!0,l.push(h.createElement("BR"))))}(c),l),function(e){r.push(function(e){var t="\n";return 3==e.nodeType&&(select.snapshotChanged(),e=makePartSpan(e,o),t=e.currentText),e.dirty=!0,s.push(e),a(e),t}(e))}),n(r.join(""),i);var c,h,l,d}(r,c))},t,function e(){throw r=e,StopIteration}),o=t.ownerDocument,s=[];var a=null;return{next:function(){return r()},nodes:s}}function i(e){for(;e&&"BR"!=e.nodeName;)e=e.previousSibling;return e}function r(e,t){for(e?"BR"==e.nodeName&&(e=e.nextSibling):e=t.firstChild;e&&"BR"!=e.nodeName;)e=e.nextSibling;return e}function o(){return(new Date).getTime()}function s(e,t,n){var i;this.editor=e,this.history=e.history,this.history.commit(),this.atOccurrence=!1,this.fallbackSize=15,n&&(i=select.cursorPos(this.editor.container))?(this.line=i.node,this.offset=i.offset):(this.line=null,this.offset=0),this.valid=!!t;var r=t.split("\n"),o=this;this.matches=1==r.length?function(){var e=cleanText(o.history.textAfter(o.line).slice(o.offset)).indexOf(t);if(e>-1)return{from:{node:o.line,offset:o.offset+e},to:{node:o.line,offset:o.offset+e+t.length}}}:function(){var e=cleanText(o.history.textAfter(o.line).slice(o.offset)),t=e.lastIndexOf(r[0]);if(-1==t||t!=e.length-r[0].length)return!1;for(var n=o.offset+t,i=o.history.nodeAfter(o.line),s=1;s<r.length-1;s++){if(cleanText(o.history.textAfter(i))!=r[s])return!1;i=o.history.nodeAfter(i)}return 0==cleanText(o.history.textAfter(i)).indexOf(r[r.length-1])&&{from:{node:o.line,offset:n},to:{node:i,offset:r[r.length-1].length}}}}function a(e){this.options=e,window.indentUnit=e.indentUnit,this.parent=parent,this.doc=document;var t=this.container=this.doc.body;this.win=window,this.history=new History(t,e.undoDepth,e.undoDelay,this,e.onChange);var i=this;if(!a.Parser)throw"No parser loaded.";if(e.parserConfig&&a.Parser.configure&&a.Parser.configure(e.parserConfig),e.readOnly||select.setCursorPos(t,{node:null,offset:0}),this.dirty=[],e.content?this.importCode(e.content):t.appendChild(this.doc.createElement("BR")),e.readOnly)e.textWrapping||(t.style.whiteSpace="nowrap");else{function r(){null!=document.body.contentEditable&&internetExplorer?document.body.contentEditable="true":document.designMode="on",document.documentElement.style.borderWidth="0",e.textWrapping||(t.style.whiteSpace="nowrap")}!1!==e.continuousScanning&&(this.scanner=this.documentScanner(e.passTime),this.delayScanning());try{r()}catch(e){var o=addEventHandler(document,"focus",function(){o(),r()},!0)}function s(){i.cursorActivity(!1)}addEventHandler(document,"keydown",method(this,"keyDown")),addEventHandler(document,"keypress",method(this,"keyPress")),addEventHandler(document,"keyup",method(this,"keyUp")),addEventHandler(document.body,"mouseup",s),addEventHandler(document.body,"paste",function(e){if(s(),internetExplorer){var t=null;try{t=window.clipboardData.getData("Text")}catch(e){}if(null!=t)i.replaceSelection(t),e.stop();else{var r=select.selectionTopNode(i.container,!0),o=r&&r.previousSibling;setTimeout(function(){!function(e,t,i){var r=select.selectionTopNode(e,!0),o=e.ownerDocument;if(null!=t&&t.parentNode!=e&&(t=i),!1===t&&(t=null),t!=r&&r&&e.firstChild){for(var s=n(t?t.nextSibling:e.firstChild);r.parentNode==e;)try{s.next()}catch(e){break}forEach(s.nodes,function(t){var n="BR"==t.nodeName?o.createElement("BR"):makePartSpan(t.currentText,o);e.replaceChild(n,t)})}}(i.container,r,o)},0)}}}),addEventHandler(document.body,"cut",s),this.options.autoMatchParens&&addEventHandler(document.body,"click",method(this,"scheduleParenBlink"))}}return s.prototype={findNext:function(){if(!this.valid)return!1;this.atOccurrence=!1;var e,t=this;for(this.line&&!this.line.parentNode&&(this.line=null,this.offset=0);;){var n=this.matches();if(n)return this.atOccurrence=n,e=n.from,t.history.textAfter(e.node).length<e.offset?(t.line=e.node,t.offset=e.offset+1):(t.line=t.history.nodeAfter(e.node),t.offset=0),!0;if(this.line=this.history.nodeAfter(this.line),this.offset=0,!this.line)return this.valid=!1,!1}},select:function(){this.atOccurrence&&(select.setCursorPos(this.editor.container,this.atOccurrence.from,this.atOccurrence.to),select.scrollToCursor(this.editor.container))},replace:function(e){if(this.atOccurrence){var t=this.editor.replaceRange(this.atOccurrence.from,this.atOccurrence.to,e);this.line=t.node,this.offset=t.offset,this.atOccurrence=!1}}},a.prototype={toggleWrapping:function(){"nowrap"==this.container.style.whiteSpace?this.container.style.whiteSpace="":this.container.style.whiteSpace="nowrap"},importCode:function(e){this.history.push(null,null,t(e)),this.history.reset()},getCode:function(){if(!this.container.firstChild)return"";var e=[];return select.markSelection(this.win),forEach(n(this.container.firstChild),method(e,"push")),webkitLastLineHack(this.container),select.selectMarked(),cleanText(e.join(""))},checkLine:function(e){if(!1===e||null!=e&&e.parentNode!=this.container)throw parent.CodeMirror.InvalidLineHandle},cursorPosition:function(e){null==e&&(e=!0);var t=select.cursorPos(this.container,e);return t?{line:t.node,character:t.offset}:{line:null,character:0}},firstLine:function(){return null},lastLine:function(){return this.container.lastChild?i(this.container.lastChild):null},nextLine:function(e){return this.checkLine(e),r(e,this.container)||!1},prevLine:function(e){return this.checkLine(e),null!=e&&i(e.previousSibling)},selectLines:function(e,t,n,i){this.checkLine(e);var r={node:e,offset:t},o=null;void 0!==i&&(this.checkLine(n),o={node:n,offset:i}),select.setCursorPos(this.container,r,o),select.scrollToCursor(this.container)},lineContent:function(e){this.checkLine(e);var t=[];for(e=e?e.nextSibling:this.container.firstChild;e&&"BR"!=e.nodeName;e=e.nextSibling)t.push(nodeText(e));return cleanText(t.join(""))},setLineContent:function(e,t){this.history.commit(),this.replaceRange({node:e,offset:0},{node:e,offset:this.history.textAfter(e).length},t),this.addDirtyNode(e),this.scheduleHighlight()},insertIntoLine:function(e,n,i){var o=null;if("end"==n)o=r(e,this.container);else for(var s=e?e.nextSibling:this.container.firstChild;s;s=s.nextSibling){if(0==n){o=s;break}var a=s.innerText||s.textContent||s.nodeValue||"";if(a.length>n){o=s.nextSibling,i=a.slice(0,n)+i+a.slice(n),removeElement(s);break}n-=a.length}for(var c=t(i),h=this.container.ownerDocument,l=0;l<c.length;l++)l>0&&this.container.insertBefore(h.createElement("BR"),o),this.container.insertBefore(makePartSpan(c[l],h),o);this.addDirtyNode(e),this.scheduleHighlight()},selectedText:function(){var e=this.history;e.commit();var t=select.cursorPos(this.container,!0),n=select.cursorPos(this.container,!1);if(!t||!n)return"";if(t.node==n.node)return e.textAfter(t.node).slice(t.offset,n.offset);for(var i=[e.textAfter(t.node).slice(t.offset)],r=e.nodeAfter(t.node);r!=n.node;r=e.nodeAfter(r))i.push(e.textAfter(r));return i.push(e.textAfter(n.node).slice(0,n.offset)),cleanText(i.join("\n"))},replaceSelection:function(e){this.history.commit();var t=select.cursorPos(this.container,!0),n=select.cursorPos(this.container,!1);t&&n&&(n=this.replaceRange(t,n,e),select.setCursorPos(this.container,t,n))},replaceRange:function(e,n,i){var r=t(i);r[0]=this.history.textAfter(e.node).slice(0,e.offset)+r[0];var o=r[r.length-1];r[r.length-1]=o+this.history.textAfter(n.node).slice(n.offset);var s=this.history.nodeAfter(n.node);return this.history.push(e.node,s,r),{node:this.history.nodeBefore(s),offset:o.length}},getSearchCursor:function(e,t){return new s(this,e,t)},reindent:function(){this.container.firstChild&&this.indentRegion(null,this.container.lastChild)},reindentSelection:function(e){if(select.somethingSelected(this.win)){var t=select.selectionTopNode(this.container,!0),n=select.selectionTopNode(this.container,!1);if(!1===t||!1===n)return;this.indentRegion(t,n,e)}else this.indentAtCursor(e)},grabKeys:function(e,t){this.frozen=e,this.keyFilter=t},ungrabKeys:function(){this.frozen="leave",this.keyFilter=null},setParser:function(e){a.Parser=window[e],this.container.firstChild&&(forEach(this.container.childNodes,function(e){3!=e.nodeType&&(e.dirty=!0)}),this.addDirtyNode(this.firstChild),this.scheduleHighlight())},keyDown:function(e){if("leave"==this.frozen&&(this.frozen=null),this.frozen&&(!this.keyFilter||this.keyFilter(e.keyCode)))return e.stop(),void this.frozen(e);var t=e.keyCode;if(this.delayScanning(),this.options.autoMatchParens&&this.scheduleParenBlink(),13==t)e.ctrlKey&&!e.altKey?this.reparseBuffer():(select.insertNewlineAtCursor(this.win),this.indentAtCursor(),select.scrollToCursor(this.container)),e.stop();else if(9==t&&"default"!=this.options.tabMode)this.handleTab(!e.ctrlKey&&!e.shiftKey),e.stop();else if(32==t&&e.shiftKey&&"default"==this.options.tabMode)this.handleTab(!0),e.stop();else if(36!=t||e.shiftKey)if(219!=t&&221!=t||!e.ctrlKey||e.altKey)if(!e.metaKey||e.shiftKey||37!=t&&39!=t)!e.ctrlKey&&!e.metaKey||e.altKey||(e.shiftKey&&90==t||89==t?(select.scrollToNode(this.history.redo()),e.stop()):90==t||8==t?(select.scrollToNode(this.history.undo()),e.stop()):83==t&&this.options.saveFunction&&(this.options.saveFunction(),e.stop()));else{var n=select.selectionTopNode(this.container);if(!1===n||!this.container.firstChild)return;if(37==t)select.focusAfterNode(i(n),this.container);else{var o=r(n,this.container);select.focusAfterNode(o?o.previousSibling:this.container.lastChild,this.container)}e.stop()}else this.blinkParens(e.shiftKey),e.stop();else this.home()&&e.stop()},keyPress:function(e){var t=/indent|default/.test(this.options.tabMode)&&a.Parser.electricChars;this.frozen&&(!this.keyFilter||this.keyFilter(e.keyCode))||13==e.code||9==e.code&&"default"!=this.options.tabMode||32==e.keyCode&&e.shiftKey&&"default"==this.options.tabMode?e.stop():t&&-1!=t.indexOf(e.character)&&this.parent.setTimeout(method(this,"indentAtCursor"),0)},keyUp:function(e){var t;this.cursorActivity((t=e.keyCode)>=16&&t<=18||t>=33&&t<=40)},indentLineAfter:function(e,t){var n=e?e.nextSibling:this.container.firstChild;n&&!hasClass(n,"whitespace")&&(n=null);var i=n?n.nextSibling:e?e.nextSibling:this.container.firstChild,r=e&&i&&i.currentText?i.currentText:"",o=0,s=n?n.currentText.length:0;null!=t&&"shift"==this.options.tabMode?o=t?s+indentUnit:Math.max(0,s-indentUnit):e?o=e.indentation(r,s,t):a.Parser.firstIndentation&&(o=a.Parser.firstIndentation(r,s,t));var c=o-s;return c<0?0==o?(i&&select.snapshotMove(n.firstChild,i.firstChild,0),removeElement(n),n=null):(select.snapshotMove(n.firstChild,n.firstChild,c,!0),n.currentText=makeWhiteSpace(o),n.firstChild.nodeValue=n.currentText):c>0&&(n?(n.currentText=makeWhiteSpace(o),n.firstChild.nodeValue=n.currentText):((n=makePartSpan(makeWhiteSpace(o),this.doc)).className="whitespace",e?insertAfter(n,e):this.container.insertBefore(n,this.container.firstChild)),i&&select.snapshotMove(i.firstChild,n.firstChild,s,!1,!0)),0!=c&&this.addDirtyNode(e),n},highlightAtCursor:function(){var e=select.selectionTopNode(this.container,!0),t=select.selectionTopNode(this.container,!1);if(!1!==e&&!1!==t)return select.markSelection(this.win),!1!==this.highlight(e,r(t,this.container),!0,20)&&(select.selectMarked(),!0)},handleTab:function(e){"spaces"==this.options.tabMode?select.insertTabAtCursor(this.win):this.reindentSelection(e)},home:function(){var e=select.selectionTopNode(this.container,!0),t=e;if(!1===e||e&&!e.isPart&&"BR"!=e.nodeName||!this.container.firstChild)return!1;for(;e&&"BR"!=e.nodeName;)e=e.previousSibling;var n=e?e.nextSibling:this.container.firstChild;return n&&n!=t&&n.isPart&&hasClass(n,"whitespace")?select.focusAfterNode(n,this.container):select.focusAfterNode(e,this.container),!0},scheduleParenBlink:function(){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);var e=this;this.parenEvent=this.parent.setTimeout(function(){e.blinkParens()},300)},blinkParens:function(e){if(window.select){this.parenEvent&&this.parent.clearTimeout(this.parenEvent),this.parenEvent=null;var t,n=this,i=select.selectionTopNode(this.container,!0);if(i&&this.highlightAtCursor()&&(i=select.selectionTopNode(this.container,!0))&&((t=c(i))||(i=i.nextSibling)&&(t=c(i)))){var o=i.className,s=h(t);for(matching[t];;){var a=l();if("dirty"!=a.status){d(i,a.status),a.node&&(d(a.node,a.status),e&&select.focusAfterNode(a.node.previousSibling,this.container));break}this.highlight(a.node,r(a.node)),a.node.dirty=!1}}}function c(e){if(e.currentText){var t=e.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return t&&t[1]}}function h(e){return/[\(\[\{]/.test(e)}function l(){for(var e,t=[],n=!0,r=i;r;r=s?r.nextSibling:r.previousSibling)if(r.className==o&&"SPAN"==r.nodeName&&(e=c(r))){if(h(e)==s?t.push(e):t.length?t.pop()!=matching[e]&&(n=!1):n=!1,!t.length)break}else if(r.dirty||"SPAN"!=r.nodeName&&"BR"!=r.nodeName)return{node:r,status:"dirty"};return{node:r,status:r&&n}}function d(e,t){e.style.fontWeight="bold",e.style.color=t?"#8F8":"#F88",n.parent.setTimeout(function(){e.style.fontWeight="",e.style.color=""},500)}},indentAtCursor:function(e){if(this.container.firstChild&&this.highlightAtCursor()){var t=select.selectionTopNode(this.container,!1);if(!1!==t){var n=i(t),r=this.indentLineAfter(n,e);t==n&&r&&(t=r),t==r&&select.focusAfterNode(t,this.container)}}},indentRegion:function(e,t,n){var o=e=i(e),s=e&&i(e.previousSibling);"BR"!=t.nodeName&&(t=r(t,this.container));do{var a=r(o,this.container);o&&this.highlight(s,a,!0),this.indentLineAfter(o,n),s=o,o=a}while(o!=t);select.setCursorPos(this.container,{node:e,offset:0},{node:t,offset:0})},cursorActivity:function(e){internetExplorer&&(this.container.createTextRange().execCommand("unlink"),this.selectionSnapshot=select.selectionCoords(this.win));var t=this.options.cursorActivity;if(!e||t){var n=select.selectionTopNode(this.container,!1);if(!1===n||!this.container.firstChild)return;n=n||this.container.firstChild,t&&t(n),e||(this.scheduleHighlight(),this.addDirtyNode(n))}},reparseBuffer:function(){forEach(this.container.childNodes,function(e){e.dirty=!0}),this.container.firstChild&&this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(e){if(e=e||this.container.firstChild){for(var t=0;t<this.dirty.length;t++)if(this.dirty[t]==e)return;3!=e.nodeType&&(e.dirty=!0),this.dirty.push(e)}},scheduleHighlight:function(){var e=this;this.parent.clearTimeout(this.highlightTimeout),this.highlightTimeout=this.parent.setTimeout(function(){e.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){for(;this.dirty.length>0;){var e=this.dirty.pop();try{for(;e&&e.parentNode!=this.container;)e=e.parentNode;if(e&&(e.dirty||3==e.nodeType))return e}catch(e){}}return null},highlightDirty:function(e){if(window.select){this.options.readOnly||select.markSelection(this.win);for(var t,n=e?null:o()+this.options.passTime;o()<n&&(t=this.getDirtyNode());){var i=this.highlight(t,n);i&&i.node&&i.dirty&&this.addDirtyNode(i.node)}return this.options.readOnly||select.selectMarked(),t&&this.scheduleHighlight(),0==this.dirty.length}},documentScanner:function(e){var t=this,n=null;return function(){if(window.select){n&&n.parentNode!=t.container&&(n=null),select.markSelection(t.win);var i=t.highlight(n,o()+e,!0);select.selectMarked();var r=i?i.node&&i.node.nextSibling:null;n=n==r?null:r,t.delayScanning()}}},delayScanning:function(){this.scanner&&(this.parent.clearTimeout(this.documentScan),this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning))},highlight:function(e,t,i,r){var s=this.container,c=this,h=this.options.activeTokens,l="number"==typeof t?t:null;if(s.firstChild){for(;e&&(!e.parserFromHere||e.dirty);){if(null!=r&&"BR"==e.nodeName&&--r<0)return!1;e=e.previousSibling}if(!e||e.nextSibling){var d=n(e?e.nextSibling:s.firstChild),u=stringStream(d),f=e?e.parserFromHere(u):a.Parser.make(u),p={current:null,get:function(){return this.current||(this.current=d.nodes.shift()),this.current},next:function(){this.current=null},remove:function(){s.removeChild(this.get()),this.current=null},getNonEmpty:function(){for(var e=this.get();e&&"SPAN"==e.nodeName&&""==e.currentText;){var t=e;this.remove(),e=this.get(),select.snapshotMove(t.firstChild,e&&(e.firstChild||e),0)}return e}},g=!1,y=!0,m=0;return forEach(f,function(n){var r=p.getNonEmpty();if("\n"==n.value){if("BR"!=r.nodeName)throw"Parser out of sync. Expected BR.";if(!r.dirty&&r.indentation||(g=!0),x(e),e=r,r.parserFromHere=f.copy(),r.indentation=n.indentation,r.dirty=!1,null==l&&r==t)throw StopIteration;if(null!=l&&o()>=l||!g&&!y&&m>1&&!i)throw StopIteration;y=g,g=!1,m=0,p.next()}else{if("SPAN"!=r.nodeName)throw"Parser out of sync. Expected SPAN.";if(r.dirty&&(g=!0),m++,function(e,t){return!t.reduced&&t.currentText==e.value&&t.className==e.style}(n,r))r.dirty=!1,p.next();else{g=!0;var a=function(e){var t=makePartSpan(e.value,c.doc);return t.className=e.style,t}(n);s.insertBefore(a,r),h&&h(a,n,c);for(var d=n.value.length,u=0;d>0;){var C=(r=p.get()).currentText.length;select.snapshotReplaceNode(r.firstChild,a.firstChild,d,u),C>d?(v(r,d),d=0):(d-=C,u+=C,p.remove())}}}}),x(e),webkitLastLineHack(this.container),{node:p.getNonEmpty(),dirty:g}}}function v(e,t){e.currentText=e.currentText.substring(t),e.reduced=!0}function x(e){e?((g||e.nextSibling!=e.oldNextSibling)&&c.history.touch(e),e.oldNextSibling=e.nextSibling):((g||c.container.firstChild!=c.container.oldFirstChild)&&c.history.touch(e),c.container.oldFirstChild=c.container.firstChild)}}},a}();addEventHandler(window,"load",function(){var e=window.frameElement.CodeMirror;e.editor=new Editor(e.options),this.parent.setTimeout(method(e,"init"),0)});