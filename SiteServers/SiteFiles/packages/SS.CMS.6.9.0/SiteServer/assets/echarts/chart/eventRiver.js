define("echarts/chart/eventRiver",["require","./base","../layout/eventRiver","zrender/shape/Polygon","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","../util/date","zrender/tool/util","zrender/tool/color","../chart"],function(e){function t(e,t,a,i,o){r.call(this,e,t,a,i,o);var n=this;n._ondragend=function(){n.isDragend=!0},this.refresh(i)}var r=e("./base"),a=e("../layout/eventRiver"),i=e("zrender/shape/Polygon");e("../component/axis"),e("../component/grid"),e("../component/dataZoom");var o=e("../config");o.eventRiver={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,itemStyle:{normal:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0,position:"inside",formatter:"{b}"}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0}}}};var n=e("../util/ecData"),l=e("../util/date"),h=e("zrender/tool/util"),s=e("zrender/tool/color");return t.prototype={type:o.CHART_TYPE_EVENTRIVER,_buildShape:function(){var e=this.series;this.selectedMap={},this._dataPreprocessing();for(var t=this.component.legend,r=[],i=0;i<e.length;i++)if(e[i].type===this.type){e[i]=this.reformOption(e[i]),this.legendHoverLink=e[i].legendHoverLink||this.legendHoverLink;var o=e[i].name||"";if(this.selectedMap[o]=!t||t.isSelected(o),!this.selectedMap[o])continue;this.buildMark(i),r.push(this.series[i])}a(r,this._intervalX,this.component.grid.getArea()),this._drawEventRiver(),this.addShapeList()},_dataPreprocessing:function(){for(var e,t,r=this.series,a=0,i=r.length;i>a;a++)if(r[a].type===this.type){e=this.component.xAxis.getAxis(r[a].xAxisIndex||0);for(var o=0,n=r[a].data.length;n>o;o++)for(var h=0,s=(t=r[a].data[o].evolution).length;s>h;h++)t[h].timeScale=e.getCoord(l.getNewDate(t[h].time)-0),t[h].valueScale=Math.pow(t[h].value,.8)}this._intervalX=Math.round(this.component.grid.getWidth()/40)},_drawEventRiver:function(){for(var e=this.series,t=0;t<e.length;t++){var r=e[t].name||"";if(e[t].type===this.type&&this.selectedMap[r])for(var a=0;a<e[t].data.length;a++)this._drawEventBubble(e[t].data[a],t,a)}},_drawEventBubble:function(e,t,r){var a=this.series,o=a[t],l=o.name||"",h=o.data[r],d=[h,o],u=this.component.legend,v=u?u.getColor(l):this.zr.getColor(t),c=this.deepMerge(d,"itemStyle.normal")||{},p=this.deepMerge(d,"itemStyle.emphasis")||{},f=this.getItemStyleColor(c.color,t,r,h)||v,g=this.getItemStyleColor(p.color,t,r,h)||("string"==typeof f?s.lift(f,-.2):f),m=this._calculateControlPoints(e),x={zlevel:o.zlevel,z:o.z,clickable:this.deepQuery(d,"clickable"),style:{pointList:m,smooth:"spline",brushType:"both",lineJoin:"round",color:f,lineWidth:c.borderWidth,strokeColor:c.borderColor},highlightStyle:{color:g,lineWidth:p.borderWidth,strokeColor:p.borderColor},draggable:"vertical",ondragend:this._ondragend};x=new i(x),this.addLabel(x,o,h,e.name),n.pack(x,a[t],t,a[t].data[r],r,a[t].data[r].name),this.shapeList.push(x)},_calculateControlPoints:function(e){var t=this._intervalX,r=e.y,a=e.evolution,i=a.length;if(!(1>i)){for(var o=[],n=[],l=0;i>l;l++)o.push(a[l].timeScale),n.push(a[l].valueScale);var h=[];h.push([o[0],r]);l=0;for(l=0;i-1>l;l++)h.push([(o[l]+o[l+1])/2,n[l]/-2+r]);for(h.push([(o[l]+(o[l]+t))/2,n[l]/-2+r]),h.push([o[l]+t,r]),h.push([(o[l]+(o[l]+t))/2,n[l]/2+r]),l=i-1;l>0;l--)h.push([(o[l]+o[l-1])/2,n[l-1]/2+r]);return h}},ondragend:function(e,t){this.isDragend&&e.target&&(t.dragOut=!0,t.dragIn=!0,t.needRefresh=!1,this.isDragend=!1)},refresh:function(e){e&&(this.option=e,this.series=e.series),this.backupShapeList(),this._buildShape()}},h.inherits(t,r),e("../chart").define("eventRiver",t),t}),define("echarts/layout/eventRiver",["require"],function(){function e(e,t,r,a){if(e===r)throw new Error("x0 is equal with x1!!!");if(t===a)return function(){return t};var i=(t-a)/(e-r),o=(a*e-t*r)/(e-r);return function(e){return i*e+o}}function t(t,r,a){var i=~~r,o=t.time.length;t.xpx=[],t.ypx=[];for(var n,l=0,h=0,s=0,d=0,u=0;o>l;l++){h=~~t.time[l],d=t.value[l]/2,l===o-1?(s=h+i,u=0):(s=~~t.time[l+1],u=t.value[l+1]/2),n=e(h,d,s,u);for(var v=h;s>v;v++)t.xpx.push(v-a),t.ypx.push(n(v))}t.xpx.push(s-a),t.ypx.push(u)}function r(e,t,r){for(var a,i=0,o=t.xpx.length,n=0;o>n;n++)a=r(t,n),i=Math.max(i,a+e[t.xpx[n]]);for(n=0;o>n;n++)a=r(t,n),e[t.xpx[n]]=i+a;return i}return function(e,a,i){function o(e,t){var r=e.importance,a=t.importance;return r>a?-1:a>r?1:0}for(var n=0;n<e.length;n++){for(var l=0;l<e[n].data.length;l++){null==e[n].data[l].weight&&(e[n].data[l].weight=1);for(var h=0,s=0;s<e[n].data[l].evolution.length;s++)h+=e[n].data[l].evolution[s].valueScale;e[n].data[l].importance=h*e[n].data[l].weight}e[n].data.sort(o)}for(n=0;n<e.length;n++){for(null==e[n].weight&&(e[n].weight=1),h=0,l=0;l<e[n].data.length;l++)h+=e[n].data[l].weight;e[n].importance=h*e[n].weight}e.sort(o);var d=Number.MAX_VALUE,u=0;for(n=0;n<e.length;n++)for(l=0;l<e[n].data.length;l++)for(s=0;s<e[n].data[l].evolution.length;s++){var v=e[n].data[l].evolution[s].timeScale;d=Math.min(d,v),u=Math.max(u,v)}d=~~d,u=~~u;var c=function(){var e=u-d+1+~~a;if(0>=e)return[0];for(var t=[];e--;)t.push(0);return t}(),p=c.slice(0),f=[],g=0,m=0;for(n=0;n<e.length;n++)for(l=0;l<e[n].data.length;l++){var x=e[n].data[l];x.time=[],x.value=[];var y,b=0;for(s=0;s<e[n].data[l].evolution.length;s++)y=e[n].data[l].evolution[s],x.time.push(y.timeScale),x.value.push(y.valueScale),b=Math.max(b,y.valueScale);t(x,a,d),x.y=r(p,x,function(e,t){return e.ypx[t]}),x._offset=r(c,x,function(){return 4}),g=Math.max(g,x.y+b),m=Math.max(m,x._offset),f.push(x)}!function(e,t,r,a){for(var i=t.height,o=a/i>.5?.5:1,n=t.y,l=(t.height-a)/r,h=0,s=e.length;s>h;h++){var d=e[h];d.y=n+l*d.y+d._offset*o,delete d.time,delete d.value,delete d.xpx,delete d.ypx,delete d._offset;for(var u=d.evolution,v=0,c=u.length;c>v;v++)u[v].valueScale*=l}}(f,i,g,m)}});