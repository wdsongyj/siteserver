var data={pageUser:null,pageConfig:null,pageAlert:null,avatarUrl:null,uploadUrl:null,files:[],editAvatar:!1,cropper:!1,accountAlertType:"",accountAlertMessage:"",mobile:"",email:"",passwordAlertType:"",passwordAlertMessage:"",oldPassword:"",newPassword:"",confirmPassword:"",deleteAlertMessage:""},methods={load:function(e,t,a){this.pageUser=e,this.pageConfig=t,this.avatarUrl=this.pageUser.avatarUrl||this.pageConfig.homeDefaultAvatarUrl||"../assets/images/default_avatar.png",this.uploadUrl=utils.getApiUrl("/v1/users/"+this.pageUser.id+"/avatar?userToken="+utils.getToken()),this.mobile=this.pageUser.mobile,this.email=this.pageUser.email},editSave:function(){this.pageAlert=null,this.editAvatar=!1;for(var e=this.files[0],t=atob(this.cropper.getCroppedCanvas().toDataURL(e.type).split(",")[1]),a=new Uint8Array(t.length),s=0;s<t.length;s++)a[s]=t.charCodeAt(s);var i=new File([a],e.name,{type:e.type});this.$refs.upload.update(e.id,{file:i,type:i.type,size:i.size,active:!0})},inputFile:function(e,t,a){e&&!t&&this.$nextTick(function(){this.editAvatar=!0}),!e&&t&&(this.editAvatar=!1),e&&t&&e.xhr&&e.success!==t.success&&(this.pageUser=e.response.value,this.avatarUrl=this.pageUser.avatarUrl)},inputFilter:function(e,t,a){if(e&&!t&&!/\.(gif|jpg|jpeg|png|webp)$/i.test(e.name))return a();if(e&&(!t||e.file!==t.file)){e.url="";var s=window.URL||window.webkitURL;s&&s.createObjectURL&&(e.url=s.createObjectURL(e.file))}},updateAccount:function(){var e=this;this.accountAlertMessage="",this.$validator.validate("account.*").then(function(t){t&&(parent.utils.loading(!0),new utils.Api("/v1/users/"+e.pageUser.id).put({mobile:e.mobile,email:e.email},function(t,a){if(parent.utils.loading(!1),t)return e.accountAlertType="danger",void(e.accountAlertMessage=t.message);e.pageUser=a.value,e.accountAlertType="success",e.accountAlertMessage="登录账号设置修改成功"}))})},updatePassword:function(){var e=this;this.passwordAlertMessage="",this.$validator.validate("password.*").then(function(t){t&&(parent.utils.loading(!0),new utils.Api("/v1/users/"+e.pageUser.id+"/actions/resetPassword").post({password:e.oldPassword,newPassword:e.newPassword},function(t,a){if(parent.utils.loading(!1),t)return e.passwordAlertType="danger",void(e.passwordAlertMessage=t.message);e.pageUser=a.value,e.passwordAlertType="success",e.passwordAlertMessage="新密码设置成功"}))})},deleteAccount:function(){var e=this;alert({title:"永久删除账户",text:"帐户删除操作无法撤销，此操作会删除您的帐户以及帐户中的所有数据",type:"warning",confirmButtonClass:"btn btn-danger",confirmButtonText:"永久删除账户",showCancelButton:!0,cancelButtonText:"取 消"}).then(function(t){t.value&&(parent.utils.loading(!0),e.deleteAlertMessage="",new utils.Api("/v1/users/"+e.pageUser.id).delete(null,function(t,a){parent.utils.loading(!1),t?e.deleteAlertMessage=error.response.data.message:alert({title:"账户已关闭",type:"success",showConfirmButton:!1}).then(function(){location.href="login.html"})}))})}};new Vue({el:"#main",data:data,components:{FileUpload:VueUploadComponent},watch:{editAvatar:function(e){e?this.$nextTick(function(){if(this.$refs.editImage){var e=new Cropper(this.$refs.editImage,{aspectRatio:1,viewMode:1});this.cropper=e}}):this.cropper&&(this.cropper.destroy(),this.cropper=!1)}},methods:methods,created:function(){var e=this;utils.getConfig("profile",function(t){t.value?e.load(t.value,t.config,t.styles):utils.redirectLogin()})}});